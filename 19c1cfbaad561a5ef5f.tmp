<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 文件列表下载器 - yingo-server/dl</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* 基础样式 - 兼容旧浏览器 */
        body {
            font-family: Arial, "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        
        header p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .status-bar {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
            overflow: hidden;
        }
        
        .status-item {
            float: left;
            margin-right: 30px;
        }
        
        .status-item:last-child {
            margin-right: 0;
        }
        
        .status-value {
            font-weight: bold;
            font-size: 16px;
        }
        
        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow: hidden;
        }
        
        .btn {
            display: inline-block;
            padding: 8px 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            margin-right: 10px;
            margin-bottom: 10px;
            float: left;
        }
        
        .btn:hover {
            background: #e9ecef;
        }
        
        .btn-primary {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .filter-options {
            float: right;
        }
        
        .filter-checkbox {
            display: inline-block;
            margin-left: 15px;
        }
        
        .files-container {
            padding: 0;
        }
        
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            border-spacing: 0;
        }
        
        thead {
            background: #e9ecef;
        }
        
        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .file-name {
            font-weight: bold;
        }
        
        .file-icon {
            color: #007bff;
            margin-right: 8px;
        }
        
        .file-size {
            color: #6c757d;
            font-size: 14px;
        }
        
        .download-links {
            min-width: 200px;
        }
        
        .download-btn {
            display: block;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
            color: #333;
            text-decoration: none;
            margin-bottom: 5px;
        }
        
        .download-btn:hover {
            background: #f8f9fa;
        }
        
        .download-btn-primary {
            background: #e3f2fd;
            border-color: #bbdefb;
            color: #0d47a1;
        }
        
        .no-files {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }
        
        footer {
            padding: 15px;
            text-align: center;
            color: #6c757d;
            font-size: 14px;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 50px 20px;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            margin: 20px;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }
        
        .repo-info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            margin: 20px;
            border: 1px solid #bee5eb;
            border-radius: 4px;
        }
        
        /* 清除浮动 - 兼容旧版浏览器 */
        .clearfix:after {
            content: "";
            display: table;
            clear: both;
        }
        
        /* 响应式调整 */
        @media screen and (max-width: 768px) {
            .status-item {
                float: none;
                display: block;
                margin-bottom: 10px;
            }
            
            .filter-options {
                float: none;
                margin-top: 10px;
            }
            
            .filter-checkbox {
                display: block;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fa fa-download"></i> GitHub 文件列表下载器</h1>
            <p>浏览并下载 yingo-server/dl 仓库中的文件（排除HTML、CSS、JS文件及子目录）</p>
        </header>
        
        <div class="status-bar clearfix">
            <div class="status-item">
                <i class="fa fa-database"></i>
                <span>仓库文件: <span class="status-value" id="file-count">0</span></span>
            </div>
            <div class="status-item">
                <i class="fa fa-filter"></i>
                <span>显示文件: <span class="status-value" id="visible-count">0</span></span>
            </div>
            <div class="status-item">
                <i class="fa fa-clock-o"></i>
                <span>最后更新: <span class="status-value" id="last-updated">-</span></span>
            </div>
        </div>
        
        <div class="controls clearfix">
            <button class="btn btn-primary" id="load-files">
                <i class="fa fa-refresh"></i> 加载文件列表
            </button>
            
            <button class="btn" id="select-all">
                <i class="fa fa-check-square-o"></i> 全选/取消全选
            </button>
            
            <button class="btn btn-success" id="download-selected">
                <i class="fa fa-download"></i> 下载选中文件
            </button>
            
            <div class="filter-options">
                <span>显示选项: </span>
                <label class="filter-checkbox">
                    <input type="checkbox" id="show-images" checked> 图片文件
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="show-documents" checked> 文档文件
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="show-archives" checked> 压缩文件
                </label>
            </div>
        </div>
        
        <div class="repo-info">
            <i class="fa fa-info-circle"></i>
            仓库: <strong>yingo-server/dl</strong> • 
            路径: <strong>根目录</strong> • 
            加速代理: <strong>http://ghproxy.net/</strong>
        </div>
        
        <div class="files-container">
            <div id="loading" class="loading" style="display:none;">
                <div class="spinner"></div>
                <p>正在从 GitHub 加载文件列表...</p>
            </div>
            
            <div id="error-container" style="display:none;"></div>
            
            <div class="table-container">
                <table id="files-table">
                    <thead>
                        <tr>
                            <th width="40">
                                <input type="checkbox" id="select-all-checkbox">
                            </th>
                            <th>文件名</th>
                            <th width="100">大小</th>
                            <th width="100">类型</th>
                            <th>下载链接</th>
                        </tr>
                    </thead>
                    <tbody id="files-list">
                        <!-- 文件列表将在这里动态生成 -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-files" class="no-files" style="display:none;">
                <i class="fa fa-folder-open-o" style="font-size:48px;"></i>
                <h3>暂无文件</h3>
                <p>点击"加载文件列表"按钮获取 GitHub 仓库中的文件</p>
            </div>
        </div>
        
        <footer>
            <p>© 2023 GitHub 文件下载器 • 使用 GitHub API 获取公开仓库文件列表 • 未认证请求每小时限制 60 次</p>
        </footer>
    </div>

    <script type="text/javascript">
        // 页面加载完成后执行
        window.onload = function() {
            // 元素引用
            var loadFilesBtn = document.getElementById('load-files');
            var filesList = document.getElementById('files-list');
            var noFilesDiv = document.getElementById('no-files');
            var loadingDiv = document.getElementById('loading');
            var errorContainer = document.getElementById('error-container');
            var fileCountSpan = document.getElementById('file-count');
            var visibleCountSpan = document.getElementById('visible-count');
            var lastUpdatedSpan = document.getElementById('last-updated');
            var selectAllBtn = document.getElementById('select-all');
            var selectAllCheckbox = document.getElementById('select-all-checkbox');
            var downloadSelectedBtn = document.getElementById('download-selected');
            var showImagesCheckbox = document.getElementById('show-images');
            var showDocumentsCheckbox = document.getElementById('show-documents');
            var showArchivesCheckbox = document.getElementById('show-archives');
            
            // 仓库信息
            var owner = 'yingo-server';
            var repo = 'dl';
            var apiUrl = 'https://api.github.com/repos/' + owner + '/' + repo + '/contents';
            var rawBaseUrl = 'https://raw.githubusercontent.com/' + owner + '/' + repo + '/main/';
            var proxyBaseUrl = 'http://ghproxy.net/';
            
            // 文件数据存储
            var allFiles = [];
            var filteredFiles = [];
            
            // 需要排除的文件扩展名
            var excludedExtensions = ['.html', '.htm', '.css', '.js', '.ts', '.jsx', '.tsx'];
            
            // 文件类型分类
            var fileCategories = {
                image: ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.svg', '.webp', '.ico'],
                document: ['.pdf', '.txt', '.md', '.doc', '.docx', '.xls', '.xlsx', '.ppt', '.pptx'],
                archive: ['.zip', '.rar', '.7z', '.tar', '.gz', '.bz2']
            };
            
            // 事件监听 - 使用传统的事件绑定方式
            loadFilesBtn.onclick = loadFilesFromGitHub;
            selectAllBtn.onclick = toggleSelectAll;
            selectAllCheckbox.onclick = toggleSelectAll;
            downloadSelectedBtn.onclick = downloadSelectedFiles;
            showImagesCheckbox.onchange = filterFiles;
            showDocumentsCheckbox.onchange = filterFiles;
            showArchivesCheckbox.onchange = filterFiles;
            
            // 页面加载时自动获取文件列表
            setTimeout(loadFilesFromGitHub, 500);
            
            // 从 GitHub 加载文件列表 - 使用 XMLHttpRequest 兼容旧浏览器
            function loadFilesFromGitHub() {
                // 显示加载状态
                showLoading(true);
                hideError();
                clearFilesList();
                
                // 创建 XMLHttpRequest 对象
                var xhr = new XMLHttpRequest();
                xhr.open('GET', apiUrl, true);
                xhr.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                processFileData(data);
                            } catch (e) {
                                showError('解析响应数据时出错: ' + e.message);
                            }
                        } else {
                            handleError(xhr.status, xhr.statusText);
                        }
                        showLoading(false);
                    }
                };
                
                xhr.onerror = function() {
                    showError('网络错误，请检查网络连接');
                    showLoading(false);
                };
                
                xhr.send();
            }
            
            // 处理文件数据
            function processFileData(data) {
                // 过滤文件：排除目录和不需要的文件类型
                allFiles = [];
                
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    
                    // 排除目录
                    if (item.type === 'dir') continue;
                    
                    // 获取文件扩展名
                    var fileName = item.name.toLowerCase();
                    var extension = '';
                    if (fileName.indexOf('.') > -1) {
                        extension = '.' + fileName.split('.').pop();
                    }
                    
                    // 排除特定扩展名的文件
                    var isExcluded = false;
                    for (var j = 0; j < excludedExtensions.length; j++) {
                        if (excludedExtensions[j] === extension) {
                            isExcluded = true;
                            break;
                        }
                    }
                    
                    if (isExcluded) continue;
                    
                    // 添加到文件列表
                    allFiles.push(item);
                }
                
                // 如果没有文件
                if (allFiles.length === 0) {
                    showNoFilesMessage();
                    updateFileCounts();
                    return;
                }
                
                // 应用初始过滤
                filterFiles();
                
                // 更新最后更新时间
                var now = new Date();
                lastUpdatedSpan.innerHTML = now.toLocaleTimeString();
            }
            
            // 处理错误
            function handleError(status, statusText) {
                if (status === 403) {
                    showError('GitHub API 速率限制已超出，请稍后再试。未认证请求每小时限制60次。');
                } else if (status === 404) {
                    showError('仓库不存在或路径错误。');
                } else {
                    showError('GitHub API 错误: ' + status + ' ' + statusText);
                }
            }
            
            // 过滤文件
            function filterFiles() {
                // 获取过滤器状态
                var showImages = showImagesCheckbox.checked;
                var showDocuments = showDocumentsCheckbox.checked;
                var showArchives = showArchivesCheckbox.checked;
                
                // 过滤文件
                filteredFiles = [];
                
                for (var i = 0; i < allFiles.length; i++) {
                    var file = allFiles[i];
                    var fileName = file.name.toLowerCase();
                    var extension = '';
                    if (fileName.indexOf('.') > -1) {
                        extension = '.' + fileName.split('.').pop();
                    }
                    
                    // 检查文件类型
                    var isImage = false;
                    var isDocument = false;
                    var isArchive = false;
                    
                    // 检查是否是图片
                    for (var j = 0; j < fileCategories.image.length; j++) {
                        if (fileCategories.image[j] === extension) {
                            isImage = true;
                            break;
                        }
                    }
                    
                    // 检查是否是文档
                    for (var j = 0; j < fileCategories.document.length; j++) {
                        if (fileCategories.document[j] === extension) {
                            isDocument = true;
                            break;
                        }
                    }
                    
                    // 检查是否是压缩包
                    for (var j = 0; j < fileCategories.archive.length; j++) {
                        if (fileCategories.archive[j] === extension) {
                            isArchive = true;
                            break;
                        }
                    }
                    
                    // 根据过滤器决定是否显示
                    if (isImage && !showImages) continue;
                    if (isDocument && !showDocuments) continue;
                    if (isArchive && !showArchives) continue;
                    
                    filteredFiles.push(file);
                }
                
                // 渲染文件列表
                renderFilesList();
                updateFileCounts();
            }
            
            // 渲染文件列表
            function renderFilesList() {
                clearFilesList();
                
                if (filteredFiles.length === 0) {
                    showNoFilesMessage();
                    return;
                }
                
                // 隐藏"暂无文件"消息
                noFilesDiv.style.display = 'none';
                
                // 为每个文件创建表格行
                for (var i = 0; i < filteredFiles.length; i++) {
                    var file = filteredFiles[i];
                    var fileName = file.name;
                    var fileSize = formatFileSize(file.size);
                    var fileType = getFileType(fileName);
                    var fileIcon = getFileIcon(fileType);
                    
                    // 处理中文文件名编码问题
                    var encodedFileName = encodeURIComponent(fileName).replace(/%2F/g, '/');
                    
                    // 创建原始和代理下载链接
                    var rawUrl = rawBaseUrl + encodedFileName;
                    var proxyUrl = proxyBaseUrl + rawUrl;
                    
                    // 创建表格行
                    var row = document.createElement('tr');
                    
                    // 复选框单元格
                    var checkboxCell = document.createElement('td');
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'file-checkbox';
                    checkbox.setAttribute('data-index', i);
                    checkbox.onchange = updateSelectAllCheckbox;
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);
                    
                    // 文件名单元格
                    var nameCell = document.createElement('td');
                    nameCell.innerHTML = '<div class="file-name"><i class="fa ' + fileIcon + ' file-icon"></i>' + escapeHtml(fileName) + '</div>';
                    row.appendChild(nameCell);
                    
                    // 文件大小单元格
                    var sizeCell = document.createElement('td');
                    sizeCell.innerHTML = '<span class="file-size">' + fileSize + '</span>';
                    row.appendChild(sizeCell);
                    
                    // 文件类型单元格
                    var typeCell = document.createElement('td');
                    typeCell.innerHTML = fileType;
                    row.appendChild(typeCell);
                    
                    // 下载链接单元格
                    var linksCell = document.createElement('td');
                    linksCell.innerHTML = 
                        '<div class="download-links">' +
                        '<a href="' + proxyUrl + '" class="download-btn download-btn-primary" target="_blank" download="' + escapeAttr(fileName) + '">加速下载 <i class="fa fa-bolt"></i></a>' +
                        '<a href="' + rawUrl + '" class="download-btn" target="_blank" download="' + escapeAttr(fileName) + '">原始链接 <i class="fa fa-external-link"></i></a>' +
                        '</div>';
                    row.appendChild(linksCell);
                    
                    filesList.appendChild(row);
                }
                
                updateSelectAllCheckbox();
            }
            
            // 清除文件列表
            function clearFilesList() {
                filesList.innerHTML = '';
            }
            
            // 显示"暂无文件"消息
            function showNoFilesMessage() {
                noFilesDiv.style.display = 'block';
            }
            
            // 显示/隐藏加载状态
            function showLoading(show) {
                if (show) {
                    loadingDiv.style.display = 'block';
                    loadFilesBtn.disabled = true;
                    loadFilesBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 加载中...';
                } else {
                    loadingDiv.style.display = 'none';
                    loadFilesBtn.disabled = false;
                    loadFilesBtn.innerHTML = '<i class="fa fa-refresh"></i> 加载文件列表';
                }
            }
            
            // 显示错误信息
            function showError(message) {
                errorContainer.innerHTML = 
                    '<div class="error-message">' +
                    '<i class="fa fa-exclamation-triangle"></i> ' +
                    '<strong>加载失败</strong><br>' +
                    escapeHtml(message) +
                    '</div>';
                errorContainer.style.display = 'block';
            }
            
            // 隐藏错误信息
            function hideError() {
                errorContainer.style.display = 'none';
            }
            
            // 更新文件计数
            function updateFileCounts() {
                fileCountSpan.innerHTML = allFiles.length;
                visibleCountSpan.innerHTML = filteredFiles.length;
            }
            
            // 切换全选/取消全选
            function toggleSelectAll() {
                var checkboxes = document.getElementsByClassName('file-checkbox');
                var isChecked = selectAllCheckbox.checked;
                
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].checked = isChecked;
                }
                
                selectAllBtn.innerHTML = isChecked ? 
                    '<i class="fa fa-times-circle"></i> 取消全选' : 
                    '<i class="fa fa-check-square-o"></i> 全选';
            }
            
            // 更新全选复选框状态
            function updateSelectAllCheckbox() {
                var checkboxes = document.getElementsByClassName('file-checkbox');
                var checkedCount = 0;
                
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        checkedCount++;
                    }
                }
                
                if (checkboxes.length === 0) {
                    selectAllCheckbox.checked = false;
                } else if (checkedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllBtn.innerHTML = '<i class="fa fa-check-square-o"></i> 全选';
                } else if (checkedCount === checkboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllBtn.innerHTML = '<i class="fa fa-times-circle"></i> 取消全选';
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllBtn.innerHTML = '<i class="fa fa-check-square-o"></i> 全选';
                }
            }
            
            // 下载选中的文件
            function downloadSelectedFiles() {
                var checkboxes = document.getElementsByClassName('file-checkbox');
                var selectedFiles = [];
                
                // 收集选中的文件
                for (var i = 0; i < checkboxes.length; i++) {
                    if (checkboxes[i].checked) {
                        var index = parseInt(checkboxes[i].getAttribute('data-index'));
                        selectedFiles.push(filteredFiles[index]);
                    }
                }
                
                if (selectedFiles.length === 0) {
                    alert('请先选择要下载的文件！');
                    return;
                }
                
                // 确认下载
                if (!confirm('您将要下载 ' + selectedFiles.length + ' 个文件。是否继续？')) {
                    return;
                }
                
                // 为每个选中的文件打开下载链接（使用代理链接）
                for (var i = 0; i < selectedFiles.length; i++) {
                    var file = selectedFiles[i];
                    var fileName = file.name;
                    
                    // 处理中文文件名编码
                    var encodedFileName = encodeURIComponent(fileName).replace(/%2F/g, '/');
                    var proxyUrl = proxyBaseUrl + rawBaseUrl + encodedFileName;
                    
                    // 在新窗口打开下载链接
                    window.open(proxyUrl, '_blank');
                }
                
                // 显示成功消息
                alert('已开始下载 ' + selectedFiles.length + ' 个文件。请检查浏览器下载列表。');
            }
            
            // 辅助函数：格式化文件大小
            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '未知大小';
                
                var sizes = ['B', 'KB', 'MB', 'GB'];
                var i = 0;
                
                while (bytes >= 1024 && i < sizes.length - 1) {
                    bytes /= 1024;
                    i++;
                }
                
                return Math.round(bytes * 100) / 100 + ' ' + sizes[i];
            }
            
            // 辅助函数：获取文件类型
            function getFileType(fileName) {
                var extension = '';
                if (fileName.indexOf('.') > -1) {
                    extension = '.' + fileName.split('.').pop().toLowerCase();
                }
                
                // 检查是否是图片
                for (var i = 0; i < fileCategories.image.length; i++) {
                    if (fileCategories.image[i] === extension) return '图片';
                }
                
                // 检查是否是文档
                for (var i = 0; i < fileCategories.document.length; i++) {
                    if (fileCategories.document[i] === extension) return '文档';
                }
                
                // 检查是否是压缩包
                for (var i = 0; i < fileCategories.archive.length; i++) {
                    if (fileCategories.archive[i] === extension) return '压缩包';
                }
                
                return '其他';
            }
            
            // 辅助函数：获取文件图标
            function getFileIcon(fileType) {
                switch(fileType) {
                    case '图片': return 'fa-file-image-o';
                    case '文档': return 'fa-file-text-o';
                    case '压缩包': return 'fa-file-archive-o';
                    default: return 'fa-file-o';
                }
            }
            
            // 辅助函数：HTML转义
            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
            
            // 辅助函数：属性转义
            function escapeAttr(text) {
                if (!text) return '';
                return text
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
        };
    </script>
</body>
</html>