<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>GitHub 文件下载器 - yingo-server/dl</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* 基础样式 */
        * {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, "Microsoft YaHei", sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
            padding: 0;
            margin: 0;
            -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        }
        
        /* 容器 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* 标题 */
        .page-header {
            text-align: center;
            padding: 15px 10px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .page-header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .page-header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* 读取me区域 */
        .readme-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 4px solid #3498db;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .readme-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 18px;
        }
        
        .readme-content {
            font-size: 15px;
            line-height: 1.6;
        }
        
        .readme-content h1, .readme-content h2, .readme-content h3 {
            color: #2c3e50;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .readme-content p {
            margin-bottom: 10px;
        }
        
        .readme-content ul, .readme-content ol {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .readme-content li {
            margin-bottom: 5px;
        }
        
        .readme-content code {
            background: #f1f1f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .readme-content pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 10px;
            border-left: 3px solid #3498db;
        }
        
        .readme-content a {
            color: #3498db;
            text-decoration: none;
        }
        
        .readme-content a:hover {
            text-decoration: underline;
        }
        
        .readme-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 15px;
            margin-left: 0;
            color: #666;
            font-style: italic;
        }
        
        /* 文件网格 */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        /* 文件卡片 */
        .file-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #eaeaea;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 120px;
            min-height: 120px;
            overflow: hidden;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .file-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            background: #f9f9f9;
        }
        
        .file-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        
        .file-icon {
            color: #3498db;
            font-size: 20px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .file-type {
            background: #f1f8ff;
            color: #0366d6;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .file-name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            word-break: break-all;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.4;
            max-height: 44px;
            flex-grow: 1;
        }
        
        .file-size {
            color: #666;
            font-size: 13px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 错误消息 */
        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #c33;
        }
        
        /* 下载模态框 */
        .download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .download-modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .modal-header h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .download-option {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #eaeaea;
            transition: all 0.2s ease;
        }
        
        .download-option:last-child {
            margin-bottom: 0;
        }
        
        .download-option:hover {
            background: #f1f8ff;
            border-color: #c8e1ff;
        }
        
        .download-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        
        .download-title i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .download-link {
            display: inline-block;
            width: 100%;
            padding: 14px 20px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            margin-top: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        .download-link:active {
            background: #2980b9;
            transform: scale(0.98);
        }
        
        .download-link.secondary {
            background: #2c3e50;
        }
        
        .download-link.secondary:active {
            background: #1a252f;
        }
        
        .modal-footer {
            padding: 15px 25px 25px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        
        .close-modal {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #666;
            padding: 10px 25px;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .close-modal:active {
            background: #e9ecef;
        }
        
        /* 状态栏 */
        .status-bar {
            background: white;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .status-item i {
            margin-right: 8px;
            color: #3498db;
        }
        
        .status-value {
            font-weight: bold;
            margin-left: 5px;
            color: #2c3e50;
        }
        
        .refresh-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        
        .refresh-btn:active {
            background: #2980b9;
            transform: scale(0.95);
        }
        
        .refresh-btn i {
            margin-right: 5px;
            color: white;
        }
        
        /* 响应式调整 */
        @media screen and (max-width: 768px) {
            .container {
                padding: 8px;
            }
            
            .files-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .file-card {
                padding: 12px;
                height: 110px;
                min-height: 110px;
            }
            
            .file-name {
                font-size: 15px;
                max-height: 40px;
            }
            
            .modal-content {
                max-width: 90%;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .refresh-btn {
                margin-top: 10px;
                align-self: flex-end;
            }
        }
        
        @media screen and (max-width: 480px) {
            .files-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .file-card {
                height: 100px;
                min-height: 100px;
            }
            
            .file-name {
                font-size: 15px;
                max-height: 40px;
            }
            
            .modal-content {
                max-width: 95%;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .download-link {
                padding: 12px 15px;
                font-size: 15px;
            }
            
            .page-header h1 {
                font-size: 20px;
            }
        }
        
        /* 横屏优化 */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            .readme-section {
                max-height: 150px;
            }
            
            .file-card {
                height: 90px;
                min-height: 90px;
            }
            
            .file-name {
                max-height: 36px;
                font-size: 14px;
            }
        }
        
        /* 高分辨率屏幕 */
        @media screen and (min-width: 1400px) {
            .files-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面标题 -->
        <div class="page-header">
            <h1><i class="fa fa-download"></i> GitHub 文件下载器</h1>
            <p>yingo-server/dl 仓库文件列表</p>
        </div>
        
        <!-- 状态栏 -->
        <div class="status-bar">
            <div>
                <div class="status-item">
                    <i class="fa fa-database"></i>
                    <span>文件总数: <span class="status-value" id="file-count">0</span></span>
                </div>
                <div class="status-item">
                    <i class="fa fa-clock-o"></i>
                    <span>最后更新: <span class="status-value" id="last-updated">-</span></span>
                </div>
            </div>
            <button class="refresh-btn" id="refresh-btn">
                <i class="fa fa-refresh"></i> 刷新列表
            </button>
        </div>
        
        <!-- README 内容区域 -->
        <div id="readme-section" class="readme-section" style="display:none;">
            <h3><i class="fa fa-file-text-o"></i> README.md</h3>
            <div id="readme-content" class="readme-content"></div>
        </div>
        
        <!-- 加载状态 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>正在从 GitHub 加载文件列表...</p>
        </div>
        
        <!-- 错误消息 -->
        <div id="error-container" class="error-message" style="display:none;"></div>
        
        <!-- 文件网格 -->
        <div id="files-grid" class="files-grid" style="display:none;"></div>
        
        <!-- 无文件提示 -->
        <div id="no-files" class="loading" style="display:none;">
            <i class="fa fa-folder-open-o" style="font-size:48px; color:#ccc; margin-bottom:15px;"></i>
            <h3>暂无文件</h3>
            <p>仓库中没有找到符合条件的文件</p>
        </div>
    </div>
    
    <!-- 下载模态框 -->
    <div id="download-modal" class="download-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fa fa-download"></i> 下载文件</h3>
                <p id="modal-filename">文件名</p>
            </div>
            <div class="modal-body">
                <div class="download-option">
                    <div class="download-title">
                        <i class="fa fa-bolt"></i> 加速下载（推荐）
                    </div>
                    <p style="color:#666; font-size:14px; margin-bottom:10px;">通过镜像代理加速下载，适合国内用户</p>
                    <a id="download-mirror" class="download-link" href="#" target="_blank">
                        <i class="fa fa-download"></i> 使用镜像下载
                    </a>
                </div>
                
                <div class="download-option">
                    <div class="download-title">
                        <i class="fa fa-github"></i> 原始链接
                    </div>
                    <p style="color:#666; font-size:14px; margin-bottom:10px;">GitHub 原始下载链接</p>
                    <a id="download-original" class="download-link secondary" href="#" target="_blank">
                        <i class="fa fa-external-link"></i> 使用原始链接下载
                    </a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="close-modal">关闭</button>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 页面加载完成后执行
        window.onload = function() {
            // 元素引用
            var loadingDiv = document.getElementById('loading');
            var errorContainer = document.getElementById('error-container');
            var filesGrid = document.getElementById('files-grid');
            var noFilesDiv = document.getElementById('no-files');
            var readmeSection = document.getElementById('readme-section');
            var readmeContent = document.getElementById('readme-content');
            var fileCountSpan = document.getElementById('file-count');
            var lastUpdatedSpan = document.getElementById('last-updated');
            var refreshBtn = document.getElementById('refresh-btn');
            var downloadModal = document.getElementById('download-modal');
            var modalFilename = document.getElementById('modal-filename');
            var downloadMirror = document.getElementById('download-mirror');
            var downloadOriginal = document.getElementById('download-original');
            var closeModalBtn = document.querySelector('.close-modal');
            
            // 仓库信息
            var owner = 'yingo-server';
            var repo = 'dl';
            var apiUrl = 'https://api.github.com/repos/' + owner + '/' + repo + '/contents';
            var rawBaseUrl = 'https://raw.githubusercontent.com/' + owner + '/' + repo + '/main/';
            var proxyBaseUrl = 'http://ghproxy.net/';
            
            // 文件数据存储
            var allFiles = [];
            
            // 需要排除的文件扩展名
            var excludedExtensions = ['.html', '.htm', '.css', '.js', '.ts', '.jsx', '.tsx'];
            
            // 文件类型映射
            var fileTypeMap = {
                // 图片
                '.png': '图片', '.jpg': '图片', '.jpeg': '图片', '.gif': '图片', 
                '.bmp': '图片', '.svg': '图片', '.webp': '图片', '.ico': '图标',
                // 文档
                '.pdf': 'PDF', '.txt': '文本', '.md': 'Markdown', '.doc': 'Word', 
                '.docx': 'Word', '.xls': 'Excel', '.xlsx': 'Excel', '.ppt': 'PPT', 
                '.pptx': 'PPT',
                // 压缩包
                '.zip': '压缩包', '.rar': '压缩包', '.7z': '压缩包', '.tar': '压缩包', 
                '.gz': '压缩包', '.bz2': '压缩包',
                // 其他常见类型
                '.json': 'JSON', '.xml': 'XML', '.csv': 'CSV', '.sql': 'SQL',
                '.exe': '可执行文件', '.dmg': '安装包', '.apk': 'APK', '.ipa': 'IPA'
            };
            
            // 文件图标映射
            var fileIconMap = {
                '图片': 'fa-file-image-o',
                'PDF': 'fa-file-pdf-o',
                '文本': 'fa-file-text-o',
                'Markdown': 'fa-file-text-o',
                'Word': 'fa-file-word-o',
                'Excel': 'fa-file-excel-o',
                'PPT': 'fa-file-powerpoint-o',
                '压缩包': 'fa-file-archive-o',
                'JSON': 'fa-file-code-o',
                'XML': 'fa-file-code-o',
                'SQL': 'fa-database',
                '可执行文件': 'fa-cog',
                '安装包': 'fa-download',
                'APK': 'fa-android',
                'IPA': 'fa-apple',
                '图标': 'fa-file-image-o',
                'CSV': 'fa-file-excel-o'
            };
            
            // 事件监听
            refreshBtn.onclick = loadAllData;
            closeModalBtn.onclick = closeDownloadModal;
            
            // 点击模态框背景关闭
            downloadModal.onclick = function(e) {
                if (e.target === downloadModal) {
                    closeDownloadModal();
                }
            };
            
            // 页面加载时自动加载数据
            setTimeout(loadAllData, 300);
            
            // 加载所有数据
            function loadAllData() {
                showLoading(true);
                hideError();
                clearFilesGrid();
                hideReadme();
                hideNoFiles();
                
                // 同时加载文件列表和README
                Promise.all([loadFilesFromGitHub(), loadReadmeFromGitHub()])
                    .then(function() {
                        showLoading(false);
                    })
                    .catch(function(error) {
                        showLoading(false);
                        showError('加载数据时出错: ' + error.message);
                    });
            }
            
            // 从 GitHub 加载文件列表
            function loadFilesFromGitHub() {
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', apiUrl, true);
                    xhr.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                try {
                                    var data = JSON.parse(xhr.responseText);
                                    processFileData(data);
                                    resolve();
                                } catch (e) {
                                    reject(new Error('解析文件数据时出错: ' + e.message));
                                }
                            } else {
                                reject(new Error('GitHub API 错误: ' + xhr.status + ' ' + xhr.statusText));
                            }
                        }
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('网络错误，请检查网络连接'));
                    };
                    
                    xhr.send();
                });
            }
            
            // 从 GitHub 加载 README
            function loadReadmeFromGitHub() {
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', apiUrl + '/README.md', true);
                    xhr.setRequestHeader('Accept', 'application/vnd.github.v3+json');
                    
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                try {
                                    var data = JSON.parse(xhr.responseText);
                                    processReadmeData(data);
                                    resolve();
                                } catch (e) {
                                    // README 加载失败不影响主要功能
                                    console.log('README 加载失败:', e.message);
                                    resolve();
                                }
                            } else if (xhr.status === 404) {
                                // README 不存在，正常情况
                                resolve();
                            } else {
                                // 其他错误，不影响主要功能
                                console.log('README 加载错误:', xhr.status);
                                resolve();
                            }
                        }
                    };
                    
                    xhr.onerror = function() {
                        // 网络错误，不影响主要功能
                        resolve();
                    };
                    
                    xhr.send();
                });
            }
            
            // 处理文件数据
            function processFileData(data) {
                // 过滤文件：排除目录和不需要的文件类型
                allFiles = [];
                
                for (var i = 0; i < data.length; i++) {
                    var item = data[i];
                    
                    // 排除目录
                    if (item.type === 'dir') continue;
                    
                    // 排除 README.md（单独显示）
                    if (item.name.toLowerCase() === 'readme.md') continue;
                    
                    // 获取文件扩展名
                    var fileName = item.name.toLowerCase();
                    var extension = '';
                    if (fileName.indexOf('.') > -1) {
                        extension = '.' + fileName.split('.').pop();
                    }
                    
                    // 排除特定扩展名的文件
                    var isExcluded = false;
                    for (var j = 0; j < excludedExtensions.length; j++) {
                        if (excludedExtensions[j] === extension) {
                            isExcluded = true;
                            break;
                        }
                    }
                    
                    if (isExcluded) continue;
                    
                    // 添加到文件列表
                    allFiles.push(item);
                }
                
                // 更新文件计数
                fileCountSpan.innerHTML = allFiles.length;
                
                // 更新最后更新时间
                var now = new Date();
                lastUpdatedSpan.innerHTML = now.toLocaleTimeString();
                
                // 如果没有文件
                if (allFiles.length === 0) {
                    showNoFiles();
                    return;
                }
                
                // 渲染文件网格
                renderFilesGrid();
            }
            
            // 处理 README 数据 - 修复base64解码问题
            function processReadmeData(data) {
                if (!data || !data.content) {
                    hideReadme();
                    return;
                }
                
                try {
                    // 修复base64解码问题
                    var base64Content = data.content.replace(/\n/g, '');
                    var content = decodeBase64UTF8(base64Content);
                    
                    // 简单 Markdown 转换
                    var htmlContent = simpleMarkdownToHtml(content);
                    
                    // 显示 README
                    readmeContent.innerHTML = htmlContent;
                    readmeSection.style.display = 'block';
                } catch (e) {
                    console.log('README 解析失败:', e);
                    hideReadme();
                }
            }
            
            // 修复：Base64解码UTF-8编码的内容
            function decodeBase64UTF8(base64) {
                // 解码base64
                var binaryString = atob(base64);
                
                // 将二进制字符串转换为UTF-8字符串
                var utf8Text = '';
                for (var i = 0; i < binaryString.length; i++) {
                    var charCode = binaryString.charCodeAt(i);
                    utf8Text += String.fromCharCode(charCode);
                }
                
                return utf8Text;
            }
            
            // 简单 Markdown 转 HTML
            function simpleMarkdownToHtml(markdown) {
                var html = markdown;
                
                // 标题
                html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
                html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
                html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
                
                // 代码块
                html = html.replace(/```([\s\S]*?)```/g, function(match, code) {
                    return '<pre><code>' + escapeHtml(code.trim()) + '</code></pre>';
                });
                
                // 行内代码
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // 链接
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                
                // 粗体
                html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
                
                // 斜体
                html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
                
                // 引用
                html = html.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
                
                // 列表
                html = html.replace(/^\s*[-*+] (.*$)/gim, '<li>$1</li>');
                // 将连续的li包裹在ul中
                html = html.replace(/(<li>.*<\/li>\s*)+/g, function(match) {
                    return '<ul>' + match + '</ul>';
                });
                
                // 数字列表
                html = html.replace(/^\s*\d+\. (.*$)/gim, '<li>$1</li>');
                // 将连续的数字列表项包裹在ol中
                html = html.replace(/(<li>.*<\/li>\s*)+(?=\s*\d+\.)/g, function(match) {
                    return '<ol>' + match + '</ol>';
                });
                
                // 处理已经包裹的列表
                html = html.replace(/<\/li>\s*<li>/g, '</li><li>');
                
                // 换行处理：两个换行符转换为段落分隔
                html = html.replace(/\n\s*\n/g, '</p><p>');
                
                // 单个换行符转换为<br>
                html = html.replace(/\n/g, '<br>');
                
                // 确保有包裹的段落
                if (!html.startsWith('<')) {
                    html = '<p>' + html + '</p>';
                }
                
                return html;
            }
            
            // 渲染文件网格
            function renderFilesGrid() {
                clearFilesGrid();
                
                // 显示文件网格
                filesGrid.style.display = 'grid';
                
                // 为每个文件创建卡片
                for (var i = 0; i < allFiles.length; i++) {
                    var file = allFiles[i];
                    var fileName = file.name;
                    var fileSize = formatFileSize(file.size);
                    
                    // 获取文件类型和图标
                    var extension = '';
                    if (fileName.indexOf('.') > -1) {
                        extension = '.' + fileName.split('.').pop().toLowerCase();
                    }
                    
                    var fileType = fileTypeMap[extension] || '文件';
                    var fileIcon = fileIconMap[fileType] || 'fa-file-o';
                    
                    // 创建文件卡片
                    var card = document.createElement('div');
                    card.className = 'file-card';
                    card.setAttribute('data-index', i);
                    
                    card.innerHTML = `
                        <div class="file-card-header">
                            <i class="fa ${fileIcon} file-icon"></i>
                            <div class="file-type">${fileType}</div>
                        </div>
                        <div class="file-name" title="${escapeHtml(fileName)}">
                            ${escapeHtml(fileName)}
                        </div>
                        <div class="file-size">${fileSize}</div>
                    `;
                    
                    // 点击卡片打开下载模态框
                    card.onclick = function() {
                        var index = parseInt(this.getAttribute('data-index'));
                        openDownloadModal(index);
                    };
                    
                    // 添加到网格
                    filesGrid.appendChild(card);
                }
            }
            
            // 打开下载模态框
            function openDownloadModal(index) {
                var file = allFiles[index];
                var fileName = file.name;
                
                // 处理中文文件名编码
                var encodedFileName = encodeURIComponent(fileName).replace(/%2F/g, '/');
                
                // 创建原始和代理下载链接
                var rawUrl = rawBaseUrl + encodedFileName;
                var proxyUrl = proxyBaseUrl + rawUrl;
                
                // 设置模态框内容
                modalFilename.textContent = fileName;
                downloadMirror.href = proxyUrl;
                downloadMirror.download = fileName;
                downloadOriginal.href = rawUrl;
                downloadOriginal.download = fileName;
                
                // 显示模态框
                downloadModal.classList.add('active');
                
                // 阻止背景滚动
                document.body.style.overflow = 'hidden';
            }
            
            // 关闭下载模态框
            function closeDownloadModal() {
                downloadModal.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            // 清除文件网格
            function clearFilesGrid() {
                filesGrid.innerHTML = '';
                filesGrid.style.display = 'none';
            }
            
            // 显示/隐藏加载状态
            function showLoading(show) {
                loadingDiv.style.display = show ? 'block' : 'none';
                refreshBtn.disabled = show;
            }
            
            // 显示错误信息
            function showError(message) {
                errorContainer.innerHTML = '<i class="fa fa-exclamation-triangle"></i> ' + escapeHtml(message);
                errorContainer.style.display = 'block';
            }
            
            // 隐藏错误信息
            function hideError() {
                errorContainer.style.display = 'none';
            }
            
            // 显示无文件提示
            function showNoFiles() {
                noFilesDiv.style.display = 'block';
            }
            
            // 隐藏无文件提示
            function hideNoFiles() {
                noFilesDiv.style.display = 'none';
            }
            
            // 显示 README
            function showReadme() {
                readmeSection.style.display = 'block';
            }
            
            // 隐藏 README
            function hideReadme() {
                readmeSection.style.display = 'none';
            }
            
            // 辅助函数：格式化文件大小
            function formatFileSize(bytes) {
                if (!bytes || bytes === 0) return '未知大小';
                
                var sizes = ['B', 'KB', 'MB', 'GB'];
                var i = 0;
                
                while (bytes >= 1024 && i < sizes.length - 1) {
                    bytes /= 1024;
                    i++;
                }
                
                return Math.round(bytes * 100) / 100 + ' ' + sizes[i];
            }
            
            // 辅助函数：HTML转义
            function escapeHtml(text) {
                if (!text) return '';
                return text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }
        };
    </script>
</body>
</html>